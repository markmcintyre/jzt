<!DOCTYPE html>
<html>
	<head>
		<title>JZT</title>
		<style type="text/css">
			#jzt {
				position: relative;
			}
			#customizers {
				position: absolute;
				top: 0;
				right: 0;
				background-color: blue;
				width: 300px;
				height: 100%;
				color: white;
			}
			textarea {
				font-family: monospace;
			}
		</style>
	</head>
	<body>
		
		<header>
			<!--<h1>Mark's Test Thing</h1>-->
		</header>
		
		<canvas id="jzt" width="640" height="480"></canvas>

		<div id="toolbox">

			<label><input type="radio" name="activeTemplate" value="" />Nothing</label>
			<label><input type="radio" name="activeTemplate" value="Wall" />Wall</label>
			<label><input type="radio" name="activeTemplate" value="SolidWall" />Solid Wall</label>
			<label><input type="radio" name="activeTemplate" value="LineWall" />Line</label>
			<label><input type="radio" name="activeTemplate" value="InvisibleWall" />Invisible Wall</label>
			<label><input type="radio" name="activeTemplate" value="BreakableWall" />Breakable Wall</label>
			<label><input type="radio" name="activeTemplate" value="FakeWall" />Fake Wall</label>
			<label><input type="radio" name="activeTemplate" value="SpiderWeb" />Spider Web</label>
			<br/>
			<label><input type="radio" name="activeTemplate" value="Water" />Water</label>
			<label><input type="radio" name="activeTemplate" value="Forest" />Forest</label>
			<label><input type="radio" name="activeTemplate" value="Door" />Door</label>
			<br/>
			<label><input type="radio" name="activeTemplate" value="Boulder" />Boulder</label>
			<label><input type="radio" name="activeTemplate" value="SliderNs" />Slider (North/South)</label>
			<label><input type="radio" name="activeTemplate" value="SliderEw" />Slider (East/West)</label>
			<br/>
			<label><input type="radio" name="activeTemplate" value="Teleporter" />Teleporter</label>
			<label><input type="radio" name="activeTemplate" value="Passage" />Passage</label>
			<br/>
			<label><input type="radio" name="activeTemplate" value="Gem" />Gem</label>
			<label><input type="radio" name="activeTemplate" value="Ammo" />Ammo</label>
			<label><input type="radio" name="activeTemplate" value="Key" />Key</label>
			<br/>
			<lable><input type="radio" name="activeTemplate" value="Pusher" />Pusher</label>
			<label><input type="radio" name="activeTemplate" value="Lion" />Lion</label>
			<label><input type="radio" name="activeTemplate" value="Tiger" />Tiger</label>
			<label><input type="radio" name="activeTemplate" value="Ruffian" />Ruffian</label>
			<label><input type="radio" name="activeTemplate" value="Centipede" />Centipede</label>
			<label><input type="radio" name="activeTemplate" value="Bear" />Bear</label>
			<label><input type="radio" name="activeTemplate" value="SpinningGun" />Spinning Gun</label>
			<label><input type="radio" name="activeTemplate" value="Spider" />Spider</label>
			<label><input type="radio" name="activeTemplate" value="Scriptable" />Scriptable</labe>
			<br/>

			<button id="save-game">Save</button>

			<label>Boards
				<select id="board-selector">
					<option value='jzt.newboard'>Create New Board</option>
				</select>
			</label>

		</div>

		<div id="customizers">
			<div id="template-customizer">
				<textarea id="active-template-editor" rows="10" style="width: 100%"></textarea>
			</div>
			<div id="script-customizer">
				<select id="script-selector"></select>
				<button id="new-script-button">New Script</button>
				<textarea id="script-editor" rows="20" style="width: 100%"></textarea>
			</div>
		</div>
		
		<script type="text/javascript" src="script/jzt.js"></script>
		<script type="text/javascript" src="script/board.js"></script>
		<script type="text/javascript" src="script/input.js"></script>
		<script type="text/javascript" src="script/basic.js"></script>
		<script type="text/javascript" src="script/script.js"></script>
		<script type="text/javascript" src="script/parser.js"></script>
		<script type="text/javascript" src="script/jztscript.js"></script>
		<script type="text/javascript" src="script/commands.js"></script>
		<script type="text/javascript" src="script/graphics.js"></script>
		<script type="text/javascript" src="script/things.js"></script>
		<script type="text/javascript" src="script/editor.js"></script>
		<script type="text/javascript">

			var templates = {};
			var boardSelector = document.getElementById('board-selector');
			var templateEditor = document.getElementById('active-template-editor');
			var scriptSelector = document.getElementById('script-selector');
			var newScriptButton = document.getElementById('new-script-button');
			var scriptEditor = document.getElementById('script-editor');
			var editor = undefined;

			function onToolSelected(event) {

				var toolType = event.target.value;

				if(toolType) {

					var activeTemplate;

					if(templates.hasOwnProperty(toolType)) {
						activeTemplate = templates[toolType];
					}
					else {
						activeTemplate = {type: toolType};
						switch(toolType) {
							case 'Passage': 
								activeTemplate.passageId = 1;
								activeTemplate.targetBoard = 'Untitled';
								break;
							case 'Spider':
								activeTemplate.under = new jzt.things.SpiderWeb().serialize();
								break;
							case 'Scriptable':
								activeTemplate.script = 'Untitled Script';
								break;
						}
						templates[toolType] = activeTemplate;
					}

					editor.setActiveTemplate(activeTemplate);

				}
				else {
					editor.setActiveTemplate(undefined);
				}
			};

			function onBoardSelected(event) {
				if(event.target.value === 'jzt.newboard') {
					var newName = window.prompt('Please enter a board name.', 'Untitled');
					if(newName) {
						newName = editor.getUniqueBoardName(newName);
						editor.addBoard(newName, 40, 15);
					}
				}
				else {
					editor.switchBoard(event.target.value);
				}
			};

			function onBoardAdded(boardName) {
				boardSelector.options[boardSelector.options.length] = new Option(boardName, boardName);
			};

			function onBoardRemoved(boardName) {

			};

			function onBoardChanged(boardName) {
				boardSelector.value = boardName;
				scriptSelector.options.length = 0;
				for(var index = 0; index < editor.currentBoard.scripts.length; ++index) {
					scriptSelector.options[index] = new Option(editor.currentBoard.scripts[index].name);
				}
				selectScript(scriptSelector.value);
			};

			function onTemplateChanged(newTemplate) {
				templateEditor.value = JSON.stringify(newTemplate, undefined, 4);
			};

			function onTemplateEdited() {
				if(templateEditor.value !== '') {
					editor.setActiveTemplate(JSON.parse(templateEditor.value));
				}
			};

			function saveGame(event) {
				editor.save();
				alert('Game Saved!');
			};

			function selectScript(scriptName) {
				var script = editor.currentBoard.getScript(scriptName);
				if(script) {
					scriptEditor.value = script.rawScript;
				}
				else {
					scriptEditor.value = '';
				}
			}

			function onScriptSelected(event) {
				selectScript(event.target.value);
			};

			function onNewScriptClick(event) {
				var newName = window.prompt('Please enter a script name.', 'Untitled');
				var script;
				if(newName) {
					newName = editor.getUniqueScriptName(newName);
					script = new jzt.Script({'name': newName, 'rawScript': ''});
					editor.currentBoard.scripts.push(script);
					scriptSelector.options[scriptSelector.options.length] = new Option(newName);
					scriptEditor.value = editor.currentBoard.getScript(newName).rawScript;
					scriptSelector.value = newName;
				}
			};

			function onScriptChanged(event) {
				var script = editor.currentBoard.getScript(scriptSelector.value);
				script.rawScript = scriptEditor.value;
			};

			var tools = document.getElementsByName('activeTemplate');
			for( var index = 0; index < tools.length; index++ ) {
        		tools[index].addEventListener('change', onToolSelected, false);
    		}	

    		var saveButton = document.getElementById('save-game');
    		saveButton.addEventListener('click', saveGame, false);

			var canvas = document.getElementById('jzt');
			var callbacks = {
				addBoard: onBoardAdded,
				removeBoard: onBoardRemoved,
				changeBoard: onBoardChanged,
				changeTemplate: onTemplateChanged
			};
			editor = new jzt.Editor(canvas, callbacks);

			boardSelector.addEventListener('change', onBoardSelected, false);
			templateEditor.addEventListener('blur', onTemplateEdited, false);
			scriptSelector.addEventListener('change', onScriptSelected, false);
			newScriptButton.addEventListener('click', onNewScriptClick, false);
			scriptEditor.addEventListener('blur', onScriptChanged, false);


		</script>
		
	</body>
</html>