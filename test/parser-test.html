<!DOCTYPE html>
<head>
    <title>Lexer Test</title>
    <link rel="stylesheet" href="qunit.css">
</head>
<body>

    <div id="qunit"></div>
    <div id="qunit-fixture"></div>
    <script src="qunit.js"></script>
    <script type="text/javascript" src="../script/lexer.js"></script>
    <script type="text/javascript" src="../script/parser.js"></script>

    <script type="text/javascript">

        function lex(text) {
            var lexer = new jzt.lexer.Lexer(text);
            return lexer.tokenizeAll();
        }

        test('Sequence', function(){
            var s = new jzt.parser.Sequence();
            var a;
            var result;

            s.add(new jzt.parser.Number());
            s.add(new jzt.parser.Word());

            a = new jzt.parser.Assembly(lex('100 hello'));
            result = s.bestMatch(a);
            ok(result, 'Expected result');
            equal(result.tokens.length, 2, 'Expected length of 2');
            deepEqual(result.tokens[0], {position: 0, line: 1, column: 1, name: 'NUMBER', value: 100}, 'result 0');
            deepEqual(result.tokens[1], {position: 4, line: 1, column: 5, name: 'WORD', value: 'hello'}, 'result 1');
            deepEqual(result.stack[0], {position: 0, line: 1, column: 1, name: 'NUMBER', value: 100}, 'stack 0');
            deepEqual(result.stack[1], {position: 4, line: 1, column: 5, name: 'WORD', value: 'hello'}, 'stack 1');

            a = new jzt.parser.Assembly(lex('hello 100'));
            result = s.bestMatch(a);
            ok(result === undefined, 'Expect no match');

            a = new jzt.parser.Assembly(lex('100 hello world'));
            result = s.bestMatch(a);
            equal(result.tokens.length, 3, 'Expected length of 3');
            equal(result.stack.length, 2, 'Expected stack length of 2');
            equal(result.stack[0].value, '100', 'Expected 100');
            equal(result.stack[1].value, 'hello', 'Expected hello');
            equal(result.index, 2, 'Expected index of 2');

            a = new jzt.parser.Assembly(lex('100 200'));
            throws(function(){s.bestMatch(a)}, /Unexpected token \'200\'/, 'Expected unexpected token exception');

            a = new jzt.parser.Assembly(lex('100'));
            throws(function(){s.bestMatch(a)}, /Token expected/, 'Expected token exception');

        });

        test('Repetition', function(){

            // Repetition
            var r = new jzt.parser.Repetition(new jzt.parser.Word());

            a = new jzt.parser.Assembly(lex('hello world this is Mark'));
            result = r.bestMatch(a);

            equal(result.tokens.length, 5, 'Expected 5 results');
            equal(result.stack.length, 5, 'Expected 5 stack');

            a = new jzt.parser.Assembly(lex('Hello world this is 100 Marks'));
            result = r.bestMatch(a);
            equal(result.tokens.length, 6, 'Expected 6 results');
            equal(result.stack.length, 4, 'Expected 4 stack');
            equal(result.stack[0].value, 'Hello', 'Hello expected');
            equal(result.stack[1].value, 'world', 'Expected world');
            equal(result.stack[2].value, 'this', 'Expected this');
            equal(result.stack[3].value, 'is', 'Expected is');

        });

        test('Alternation', function(){

            // Alternation
            var alt = new jzt.parser.Alternation();
            alt.add(new jzt.parser.Literal('hello'));
            alt.add(new jzt.parser.Literal('world'));
            alt.add(new jzt.parser.Literal(','));

            a = new jzt.parser.Assembly(lex('hello'));
            result = alt.bestMatch(a);
            equal(result.tokens.length, 1, 'Expected 1 result');
            equal(result.stack.length, 1, 'Expected 1 stack');
            equal(result.stack[0].value, 'hello', 'Expected hello');

            a = new jzt.parser.Assembly(lex('world'));
            result = alt.bestMatch(a);
            equal(result.tokens.length, 1, 'Expected 1 result');
            equal(result.stack.length, 1, 'Expected 1 stack');
            equal(result.stack[0].value, 'world', 'Expected world');

            a = new jzt.parser.Assembly(lex(','));
            result = alt.bestMatch(a);
            equal(result.tokens.length, 1, 'Expected 1 result');
            equal(result.stack.length, 1, 'Expected 1 stack');
            equal(result.stack[0].value, ',', 'Expected !');

            a = new jzt.parser.Assembly(lex('mark'));
            result = alt.bestMatch(a);
            ok(result === undefined, 'Expected no result');

        });

        test('Repetition of Alternations', function(){

            // Repetition of Alternation

            var alt = new jzt.parser.Alternation();
            alt.add(new jzt.parser.Literal('hello'));
            alt.add(new jzt.parser.Literal('world'));
            alt.add(new jzt.parser.Literal(','));

            r = new jzt.parser.Repetition(alt);

            a = new jzt.parser.Assembly(lex('hello world,'));
            result = r.bestMatch(a);
            equal(result.tokens.length, 3, 'Expected 3 results');
            equal(result.stack.length, 3, 'Expected stack of 3');
            equal(result.stack[0].value, 'hello', 'Expected hello');
            equal(result.stack[1].value, 'world', 'Expected world');
            equal(result.stack[2].value, ',', 'Expected ,');

            a = new jzt.parser.Assembly(lex('world, ,, hello ,world hello,'));
            result = r.bestMatch(a);
            equal(result.tokens.length, 9, 'Expected 9 tokens');
            equal(result.stack.length, 9, 'Expected stack of 9');
            equal(result.stack[0].value, 'world', 'Expected world');
            equal(result.stack[1].value, ',', 'Expected ,');
            equal(result.stack[2].value, ',', 'Expected ,');
            equal(result.stack[3].value, ',', 'Expected ,');
            equal(result.stack[4].value, 'hello', 'Expected hello');
            equal(result.stack[5].value, ',', 'Expected ,');
            equal(result.stack[6].value, 'world', 'Expected world');
            equal(result.stack[7].value, 'hello', 'Expected hello');
            equal(result.stack[8].value, ',', 'Expected ,');

            a = new jzt.parser.Assembly(lex('hello world mark,'));
            result = r.bestMatch(a);
            equal(result.tokens.length, 4, 'Expected 4 tokens');
            equal(result.stack.length, 2, 'Expected stack of 2');
            equal(result.stack[0].value, 'hello', 'Expected hello');
            equal(result.stack[1].value, 'world', 'Expected world');

            a = new jzt.parser.Assembly(lex('I said hello world,'));
            result = r.bestMatch(a);
            equal(result.tokens.length, 5, 'Expected 5 results');
            equal(result.stack.length, 0, 'Expected stack of 0');

            a = new jzt.parser.Assembly(lex(','));
            result = r.bestMatch(a);
            equal(result.tokens.length, 1, 'Expected 1 token');
            equal(result.stack.length, 1, 'Expected stack of 1');
            equal(result.stack[0].value, ',', 'Expected ,');

        });

    </script>

</body>
